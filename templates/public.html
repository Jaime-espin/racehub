<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RaceHub - Mi Calendario</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 style="margin: 0;">üèÉ‚Äç‚ôÇÔ∏è RaceHub</h1>
            <div class="toggle-container">
                <button id="btnTabla" class="toggle-btn active" onclick="cambiarVista('tabla')">üìã Tabla</button>
                <button id="btnCalendario" class="toggle-btn" onclick="cambiarVista('calendario')">üìÖ Calendario</button>
            </div>
        </div>
        
        <div id="loading">
            <div class="spinner"></div> Analizando webs oficiales, espera unos segundos...
        </div>

        <div id="confirmacion"></div>

        <div id="lista-carreras">Cargando datos...</div>
    </div>

    <script>
        const shareToken = "{{ share_token }}";
        const ownerName = "{{ owner_name }}";

        let datosEncontrados = null;
        let vistaActual = 'tabla'; // 'tabla' o 'calendario'
        let carrerasCache = [];

        function cambiarVista(vista) {
            vistaActual = vista;
            document.getElementById('btnTabla').classList.toggle('active', vista === 'tabla');
            document.getElementById('btnCalendario').classList.toggle('active', vista === 'calendario');
            renderizarCarreras(carrerasCache);
        }

        async function cargarCarreras() {
            let url = '/carreras';
            if (shareToken && shareToken !== "None" && shareToken.trim() !== "") {
                 url = `/api/share/${shareToken}/carreras`;
                 // Update title if viewing someone else's calendar
                 if (ownerName && ownerName !== "nulo" && ownerName !== "None") {
                      document.querySelector('h1').innerText = `üèÉ‚Äç‚ôÇÔ∏è Calendario de ${ownerName}`;
                 }
            }

            const response = await fetch(url);
            const carreras = await response.json();
            carrerasCache = carreras;
            renderizarCarreras(carreras);
        }

        function renderizarCarreras(carreras) {
            const listaDiv = document.getElementById('lista-carreras');
            
            if (!carreras || carreras.length === 0) {
                listaDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">üì≠ No se a√±adi√≥ ninguna carrera todav√≠a.</p>';
                return;
            }
            
            carreras.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
            
            if (vistaActual === 'tabla') {
                renderizarTabla(carreras, listaDiv);
            } else {
                renderizarCalendario(carreras, listaDiv);
            }
        }

        function renderizarTabla(carreras, listaDiv) {
            let html = `<table>
                <tr>
                    <th>Fecha</th>
                    <th>Carrera</th>
                    <th>Deporte</th>
                    <th>Lugar</th>
                    <th>Estado</th>
                </tr>`;

            carreras.forEach(c => {
                html += `<tr>
                    <td>${c.fecha}</td>
                    <td>
                        <strong>${c.nombre}</strong><br>
                        <small style="color:#777">${c.distancia_resumen || ''}</small>
                    </td>
                    <td>${c.deporte}</td>
                    <td>${c.localizacion}</td>
                    <td><span class="badge ${c.estado_inscripcion || 'pendiente'}">${c.estado_inscripcion || 'Pendiente'}</span></td>
                </tr>`;
            });
            html += '</table>';
            listaDiv.innerHTML = html;
        }

        function renderizarCalendario(carreras, listaDiv) {
            // Agrupar carreras por mes
            const carrerasPorMes = {};
            carreras.forEach(c => {
                const fecha = new Date(c.fecha);
                const mesKey = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                if (!carrerasPorMes[mesKey]) {
                    carrerasPorMes[mesKey] = [];
                }
                carrerasPorMes[mesKey].push(c);
            });

            let html = '<div class="calendario-container">';
            
            Object.keys(carrerasPorMes).sort().forEach(mesKey => {
                const [ano, mes] = mesKey.split('-');
                const nombreMes = new Date(ano, mes - 1).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                
                html += `<div class="mes-grupo">
                    <h3 class="mes-titulo">${nombreMes.charAt(0).toUpperCase() + nombreMes.slice(1)}</h3>
                    <div class="carreras-mes">`;
                
                carrerasPorMes[mesKey].forEach(c => {
                    const fecha = new Date(c.fecha);
                    const dia = fecha.getDate();
                    const diaSemana = fecha.toLocaleDateString('es-ES', { weekday: 'short' });
                    
                    html += `<div class="carrera-card">
                        <div class="carrera-fecha">
                            <div class="dia">${dia}</div>
                            <div class="dia-semana">${diaSemana}</div>
                        </div>
                        <div class="carrera-info">
                            <h4>${c.nombre}</h4>
                            <p><strong>üìç</strong> ${c.localizacion}</p>
                            <p><strong>üèÉ</strong> ${c.deporte} - ${c.distancia_resumen || ''}</p>
                            <span class="badge ${c.estado_inscripcion || 'pendiente'}">${c.estado_inscripcion || 'Pendiente'}</span>
                        </div>
                    </div>`;
                });
                
                html += '</div></div>';
            });
            
            html += '</div>';
            listaDiv.innerHTML = html;
        }

        async function buscarCarrera() {
            const input = document.getElementById('nombreInput');
            const btn = document.getElementById('btnBuscar');
            const loading = document.getElementById('loading');
            const confirmacionDiv = document.getElementById('confirmacion');
            const nombre = input.value;

            if (!nombre) return alert("Escribe un nombre primero");

            // Ocultar confirmaci√≥n previa si existe
            confirmacionDiv.style.display = 'none';

            // Interfaz: Bloqueamos bot√≥n y mostramos carga
            btn.disabled = true;
            loading.style.display = 'block';

            try {
                const response = await fetch('/carreras/buscar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre: nombre })
                });

                if (response.ok) {
                    datosEncontrados = await response.json();
                    
                    // Mostrar datos encontrados para confirmaci√≥n
                    confirmacionDiv.innerHTML = `
                        <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #27ae60;">
                            <h3 style="margin-top: 0; color: #27ae60;">üìã Datos encontrados por la IA:</h3>
                            <p><strong>üèÜ Nombre:</strong> ${datosEncontrados.nombre_oficial}</p>
                            <p><strong>üö¥ Deporte:</strong> ${datosEncontrados.deporte}</p>
                            <p><strong>üìÖ Fecha:</strong> ${datosEncontrados.fecha}</p>
                            <p><strong>üìç Lugar:</strong> ${datosEncontrados.lugar}</p>
                            <p><strong>üìè Distancias:</strong> ${datosEncontrados.distancias.join(', ')}</p>
                            <p><strong>üîó URL:</strong> ${datosEncontrados.url_oficial || 'No disponible'}</p>
                            <p><strong>üìù Estado:</strong> ${datosEncontrados.estado_inscripcion}</p>
                            
                            <div style="margin-top: 20px; display: flex; gap: 10px;">
                                <button onclick="confirmarGuardado()" style="background: #27ae60;">‚úÖ Confirmar y Guardar</button>
                                <button onclick="cancelarBusqueda()" style="background: #e74c3c;">‚ùå Cancelar</button>
                            </div>
                        </div>
                    `;
                    confirmacionDiv.style.display = 'block';
                    input.value = ''; // Limpiar input
                } else {
                    const error = await response.json();
                    alert("‚ùå Error: " + (error.detail || "No se pudo procesar"));
                }
            } catch (err) {
                alert("‚ùå Error de conexi√≥n: " + err);
            } finally {
                // Interfaz: Restauramos estado
                btn.disabled = false;
                loading.style.display = 'none';
            }
        }

        async function confirmarGuardado() {
            if (!datosEncontrados) return;

            try {
                const response = await fetch('/carreras/confirmar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datosEncontrados)
                });

                if (response.ok) {
                    document.getElementById('confirmacion').style.display = 'none';
                    cargarCarreras();
                    alert("‚úÖ ¬°Carrera guardada correctamente!");
                    datosEncontrados = null;
                } else {
                    const error = await response.json();
                    alert("‚ùå Error al guardar: " + (error.detail || "No se pudo guardar"));
                }
            } catch (err) {
                alert("‚ùå Error de conexi√≥n al guardar");
            }
        }

        function cancelarBusqueda() {
            document.getElementById('confirmacion').style.display = 'none';
            datosEncontrados = null;
            alert("‚ùå Operaci√≥n cancelada");
        }

        async function eliminarCarrera(id, nombre) {
            if (!confirm(`¬øEst√°s seguro de eliminar "${nombre}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/carreras/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    cargarCarreras();
                    alert(`‚úÖ Carrera "${nombre}" eliminada correctamente`);
                } else {
                    const error = await response.json();
                    alert("‚ùå Error al eliminar: " + (error.detail || "No se pudo eliminar"));
                }
            } catch (err) {
                alert("‚ùå Error de conexi√≥n al eliminar");
            }
        }

        // Cargar al inicio
        cargarCarreras();
    </script>
</body>
</html>